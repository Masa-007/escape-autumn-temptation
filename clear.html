<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>クリア!! - EAT</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: "Segoe UI", "Helvetica", sans-serif;
    overflow: hidden;
    background: url("./assets/images/end1.png") no-repeat center center fixed;
    background-size: cover;
  }

  #leafCanvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 1;
  }

  .storyContainer {
    position: absolute;
    bottom: 5%;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 2;
    white-space: nowrap;
  }

  .fadeImage {
    width: 60%;
    max-width: 500px;
    height: auto;
    display: none;
    opacity: 0;
    transition: opacity 0.8s ease;
    margin-top: 15px;
  }

  #textBox {
    width: 95%;
    max-width: 1000px;
    min-height: 150px;
    padding: 25px;
    background: rgba(0,0,0,0.6);
    color: #fff;
    font-size: 1.25rem;
    line-height: 1.6;
    border-radius: 15px;
    text-align: center;
    display: flex;
    justify-content: center;
    align-items: center;
    white-space: normal;
    word-break: normal;
    margin-bottom: 15px;
    opacity: 0;
    transition: opacity 0.8s ease;
  }

  #endContainer {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 3;
    opacity: 0;
  }

  #endContainer .actionBtn + .actionBtn { margin-top: 20px; }

  .decorText {
    font-family: 'Brush Script MT', cursive;
    color: #ffd700;
    font-size: 3rem;
    text-align: center;
    text-shadow: 3px 3px 7px #000;
    margin-bottom: 20px;
  }

  .actionBtn {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 15px 35px;
    font-size: 18px;
    font-weight: bold;
    border-radius: 10px;
    cursor: pointer;
    text-decoration: none;
    border: none;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    width: 220px;
    text-align: center;
  }

  #homeBtn { background: linear-gradient(135deg, #ff7e5f, #feb47b); color: white; }
  #shareLink { background: linear-gradient(135deg, #4c6ef5, #15aabf); color: white; }

  .actionBtn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.4); }

  @media (max-width: 768px) {
    .fadeImage, #textBox { width: 90%; max-width: 300px; }
    #textBox { font-size: 1rem; padding: 15px; min-height: 150px; }
    .decorText { font-size: 2rem; margin-bottom: 20px; }
    #endContainer .actionBtn + .actionBtn { margin-top: 15px; }
    .actionBtn { width: 70%; font-size: 16px; padding: 12px 20px; }
  }
</style>
</head>
<body>

<canvas id="leafCanvas"></canvas>

<div class="storyContainer">
  <img id="img2" class="fadeImage" src="./assets/images/end2.png" alt="">
  <img id="img3" class="fadeImage" src="./assets/images/end3.png" alt="">
  <img id="img4" class="fadeImage" src="./assets/images/end4.png" alt="">
  <div id="textBox"></div>
</div>

<div id="endContainer">
  <div id="thankText" class="decorText">GAME CLEAR!! <br>Thank you for playing!!</div>
  <button id="homeBtn" class="actionBtn">修行に戻る</button>
  <a id="shareLink" class="actionBtn" target="_blank"
     href="https://twitter.com/intent/tweet?text=%E5%AE%8C%E5%85%A8%E3%82%AF%E3%83%AA%E3%82%A2%E3%81%97%E3%81%A6%E3%82%A8%E3%83%B3%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0%E3%82%92%E8%A6%B3%E3%81%9F!!%20%23ETA%20%23EscapeAutumnTemptation%20%23RUNTEQ%20%23%E3%83%9F%E3%83%8B%E3%82%A2%E3%83%97%E3%83%AAWeek2025%0Ahttps://masa-007.github.io/escape-autumn-temptation/">Xで感想を共有する</a>
</div>

<script>
  const canvas = document.getElementById("leafCanvas");
  const ctx = canvas.getContext("2d");
  function resizeCanvas(){canvas.width=window.innerWidth;canvas.height=window.innerHeight;}
  window.addEventListener('resize',resizeCanvas);
  resizeCanvas();

  const lights=[];
  for(let i=0;i<60;i++){
    lights.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,speedY:0.2+Math.random()*0.7,speedX:(Math.random()*0.3)-0.15,radius:2+Math.random()*3,alpha:0.5+Math.random()*0.5,alphaChange:0.01+Math.random()*0.02});
  }
  function drawLight(l){ctx.save();ctx.globalAlpha=l.alpha;const g=ctx.createRadialGradient(l.x,l.y,0,l.x,l.y,l.radius);g.addColorStop(0,"rgba(255,215,0,1)");g.addColorStop(0.5,"rgba(255,215,0,0.6)");g.addColorStop(1,"rgba(255,215,0,0)");ctx.fillStyle=g;ctx.beginPath();ctx.arc(l.x,l.y,l.radius,0,Math.PI*2);ctx.fill();ctx.restore();}
  function animateLights(){ctx.clearRect(0,0,canvas.width,canvas.height);lights.forEach(l=>{l.y+=l.speedY;l.x+=l.speedX;l.alpha+=l.alphaChange;if(l.alpha>1||l.alpha<0.3)l.alphaChange*=-1;if(l.y>canvas.height)l.y=-l.radius;if(l.x>canvas.width)l.x=0;if(l.x<0)l.x=canvas.width;drawLight(l);});requestAnimationFrame(animateLights);}
  animateLights();

  const textBox = document.getElementById("textBox");
  const endContainer = document.getElementById("endContainer");
  const shareLink = document.getElementById("shareLink");
  const story=[
    {text:"*Enterキーorタッチで進めてください。",img:null},
    {text:"滝に打たれていたはずの男は気がつくと、木漏れ日の中にいた。<br>「ここが神の境地なのか…?」<br>男は目を瞑りながらつぶやいた。",img:null},
    {text:"秋の味覚を超えた男は神の境地へと至っていた。<br>ここには何の欲も存在しない。静寂だけがそこに息づいていた。",img:"img2"},
    {text:"ついに目を開けると、そこにはバスケットに入った<br>赤々と神々しく輝く1粒のリンゴがあった。",img:"img3"},
    {text:"男はフッと笑った。<br>そしてりんごを手に取り、一口かじった。",img:"img4"},
    {text:"「ああ、これが秋の味覚か、こんなに美味いとはな。<br>チッ、なぁんだ。また修行のやり直しだぜ。」<br>男はそう言って微笑んだ。",img:null}
  ];

  let index = 0;
  let lastImg = null;
  let waitingForFinalClick = false;

  textBox.innerHTML = story[0].text;
  textBox.style.opacity = 1;
  textBox.style.display = "flex";
  index = 1;

  function showStory(){
    if(index < story.length){
      textBox.style.opacity = 0;
      if(lastImg) lastImg.style.opacity = 0;

      setTimeout(()=> {
        if(lastImg) lastImg.style.display = "none";

        const imgId = story[index].img;
        if(imgId){
          const imgEl = document.getElementById(imgId);
          imgEl.style.display = "block";
          setTimeout(()=>{ imgEl.style.opacity = 1; }, 50);
          lastImg = imgEl;
        } else { lastImg = null; }

        textBox.innerHTML = story[index].text;
        textBox.style.opacity = 1;
        textBox.style.display = "flex";

        index++;
        if(index === story.length) waitingForFinalClick = true;
      }, 800);
    }
  }

  function handleAdvance(e){
    if(e.target.tagName==="BUTTON"||e.target.tagName==="A") return;
    if(e.type==="touchstart"){e.preventDefault();}

    if(waitingForFinalClick){
      textBox.style.opacity = 0;
      if(lastImg) lastImg.style.opacity = 0;
      setTimeout(()=>{
        textBox.style.display = "none";
        if(lastImg) lastImg.style.display = "none";
        endContainer.style.opacity = 1;
      }, 800);
      waitingForFinalClick = false;
      return;
    }

    showStory();
  }

  document.body.addEventListener("touchstart", handleAdvance, {passive:false});
  document.body.addEventListener("click", handleAdvance);
  document.body.addEventListener("keydown", (e)=>{if(e.key==="Enter") handleAdvance(e);});

  document.getElementById("homeBtn").addEventListener("click", ()=>{window.location.href="index.html";});

  // ================= Xシェア用イベント =================
  shareLink.addEventListener("click", (e)=>{
    e.preventDefault();
    const url = shareLink.href;
    window.open(url, "_blank");
  });
</script>
</body>
</html>
